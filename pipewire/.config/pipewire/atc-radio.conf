# ATC Radio Mic — PipeWire filter chain
# Captures from real mic, applies radio bandpass effect, exposes as virtual source
# Run with: pipewire -c ~/.config/pipewire/atc-radio.conf

context.properties = {
    log.level = 0
}

context.spa-libs = {
    audio.convert.* = audioconvert/libspa-audioconvert
    support.*       = support/libspa-support
}

context.modules = [
    { name = libpipewire-module-rt
        args = { nice.level = -11 rt.prio = 88 }
        flags = [ ifexists nofail ]
    }
    { name = libpipewire-module-protocol-native }
    { name = libpipewire-module-client-node }
    { name = libpipewire-module-adapter }

    { name = libpipewire-module-filter-chain
        args = {
            audio.channels  = 2
            audio.position  = [ FL FR ]
            node.description = "ATC Radio Mic"
            media.name       = "ATC Radio Mic"

            filter.graph = {
                nodes = [
                    # Highpass cascade (cuts below 350Hz — no bass, like real radio)
                    {
                        type = builtin
                        name = hp1
                        label = bq_highpass
                        control = { "Freq" = 350.0 "Q" = 1.0 }
                    }
                    {
                        type = builtin
                        name = hp2
                        label = bq_highpass
                        control = { "Freq" = 350.0 "Q" = 1.0 }
                    }
                    # Lowpass cascade (cuts above 2800Hz — radio bandwidth)
                    {
                        type = builtin
                        name = lp1
                        label = bq_lowpass
                        control = { "Freq" = 2800.0 "Q" = 1.0 }
                    }
                    {
                        type = builtin
                        name = lp2
                        label = bq_lowpass
                        control = { "Freq" = 2800.0 "Q" = 1.0 }
                    }
                    # Mid presence boost (nasal radio character)
                    {
                        type = builtin
                        name = mid1
                        label = bq_peaking
                        control = { "Freq" = 1200.0 "Q" = 0.8 "Gain" = 3.0 }
                    }
                    # Intelligibility boost
                    {
                        type = builtin
                        name = mid2
                        label = bq_peaking
                        control = { "Freq" = 2000.0 "Q" = 0.6 "Gain" = 2.0 }
                    }
                ]
                links = [
                    { output = "hp1:Out"  input = "hp2:In" }
                    { output = "hp2:Out"  input = "lp1:In" }
                    { output = "lp1:Out"  input = "lp2:In" }
                    { output = "lp2:Out"  input = "mid1:In" }
                    { output = "mid1:Out" input = "mid2:In" }
                ]
            }

            capture.props = {
                node.name      = "atc_radio.input"
                node.passive   = true
                node.target    = "atc_radio_mixer.monitor"
            }
            playback.props = {
                node.name    = "atc_radio.output"
                media.class  = Audio/Source
            }
        }
    }
]
